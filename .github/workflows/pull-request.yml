# Running tests with tox for releasing new version

name: Pull requests fosslight_prechecker

on:
  pull_request:
    branches:
       - '*'

jobs:
  check-commit-message:
    name: Check Commit Message
    uses: fosslight/.github/.github/workflows/base-check-commit-message.yml@main
    secrets:
      envPAT: ${{ secrets.GITHUB_TOKEN }}
  build:
    name: Build packages
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            TARGET: ubuntu
            CMD_BUILD: >
                tox -e ubuntu
            OUT_FILE_NAME: fosslight_bin_ubuntu
            ASSET_MIME: application/octet-stream
          - os: windows-latest
            TARGET: windows
            CMD_BUILD: |
                tox -e windows
                pyinstaller --onefile cli.py -n cli --additional-hooks-dir=hooks --collect-datas reuse --collect-datas fosslight_util --add-data="src\fosslight_prechecker\templates\default_template.jinja2;." &&
                move dist\cli.exe fosslight_prechecker_windows.exe && .\fosslight_prechecker_windows.exe
            OUT_FILE_NAME: fosslight_prechecker_windows.exe
            ASSET_MIME: application/vnd.microsoft.portable-executable
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tox
        pip install .
        pip install pyinstaller
    - name: Build with pyinstaller for ${{matrix.TARGET}}
      run: ${{matrix.CMD_BUILD}}
  reuse:
    runs-on: ubuntu-latest
    steps: 
    - uses: actions/checkout@v3
    - name: REUSE Compliance Check
      uses: fsfe/reuse-action@v1

  pr-review:
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get diff
        id: diff
        run: |
          git diff "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}" -- . > diff.txt
          echo "size=$(wc -c < diff.txt)" >> $GITHUB_OUTPUT
      - name: Skip if no code change
        id: skip
        run: |
          if [ "${{ steps.diff.outputs.size }}" -lt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Request review from service
        id: review
        if: steps.skip.outputs.skip != 'true'
        timeout-minutes: 15
        env:
          SERVICE_URL: ${{ secrets.PR_REVIEW_SERVICE_URL }}
        run: |
          echo '{"pr_title": ${{ toJSON(github.event.pull_request.title) }}, "pr_body": ${{ toJSON(github.event.pull_request.body) }}}' > meta.json
          jq -n --rawfile diff diff.txt --slurpfile m meta.json '$m[0] + {diff: $diff}' > payload.json
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 900 -X POST "${SERVICE_URL}/review" \
            -H "Content-Type: application/json" \
            -d @payload.json) || true
          HTTP_BODY=$(echo "$RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$HTTP_BODY" | jq -r '.body // empty' 2>/dev/null)
          ERR_MSG=$(echo "$HTTP_BODY" | jq -r '.error // .message // .detail // empty' 2>/dev/null)
          echo "## ğŸ¤– LLM ë¦¬ë·° ìš”ì•½" > review_body.md
          echo "" >> review_body.md
          if [ -n "$BODY" ]; then
            echo "$BODY" >> review_body.md
          else
            echo "ë¦¬ë·° ìƒì„±ì— ì‹¤íŒ¨í–ˆê±°ë‚˜ ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤." >> review_body.md
            if [ -n "$ERR_MSG" ]; then
              echo "" >> review_body.md
              echo "**ì—ëŸ¬ ë©”ì‹œì§€:** $ERR_MSG" >> review_body.md
            elif [ -n "$HTTP_CODE" ] && [ "$HTTP_CODE" -ge 400 ]; then
              echo "" >> review_body.md
              echo "**HTTP ìƒíƒœ:** $HTTP_CODE" >> review_body.md
            fi
          fi
      - name: Post review comment
        if: steps.skip.outputs.skip != 'true' && success()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.TOKEN || secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: review_body.md
          edit-mode: replace
      - name: Comment when no code change
        if: steps.skip.outputs.skip == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.TOKEN || secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: "## ğŸ¤– LLM ë¦¬ë·° ìš”ì•½\n\nì´ PRì—ëŠ” ë¦¬ë·°í•  ì½”ë“œ ë³€ê²½ì´ ì—†ìŠµë‹ˆë‹¤."
          edit-mode: replace
